<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enterprise CI/CD Dashboard</title>
  <style>
    :root {
      --bg: #f8f9fc;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e2e8f0;
      --accent: #3b82f6;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      --card-bg: white;
    }
    [data-theme="dark"] {
      --bg: #0f172a;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --border: #334155;
      --accent: #60a5fa;
      --card-bg: #1e293b;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .container {
      display: grid;
      grid-template-areas: "sidebar header" "sidebar main";
      grid-template-columns: 280px 1fr;
      grid-template-rows: 70px 1fr;
      height: 100vh;
    }
    
    .sidebar {
      grid-area: sidebar;
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      padding: 1.5rem;
      overflow-y: auto;
    }
    
    .header {
      grid-area: header;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .main {
      grid-area: main;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .logo {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 2rem;
      color: var(--accent);
    }
    
    .nav-section {
      margin-bottom: 2rem;
    }
    
    .nav-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 0.75rem;
      letter-spacing: 0.5px;
    }
    
    .nav-item {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.25rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    
    .nav-item:hover {
      background: var(--bg);
    }
    
    .nav-item.active {
      background: var(--accent);
      color: white;
    }
    
    .badge {
      margin-left: auto;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      background: var(--danger);
      color: white;
    }
    
    .team-selector {
      margin-top: 1.5rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
    }
    
    .team-selector select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    
    .branch-switcher {
      display: flex;
      gap: 0.5rem;
    }
    
    .branch-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .branch-btn:hover {
      border-color: var(--accent);
    }
    
    .branch-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .realtime-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-badge {
      padding: 0.5rem 1rem;
      background: var(--bg);
      border-radius: 6px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .role-tag {
      padding: 0.2rem 0.5rem;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .metric-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .metric-label {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .action-bar {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .action-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-primary:hover {
      filter: brightness(1.1);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-secondary {
      background: var(--bg);
      color: var(--text);
    }
    
    .table-container {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: var(--bg);
    }
    
    th {
      padding: 1rem;
      text-align: left;
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 600;
    }
    
    td {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }
    
    tbody tr:hover {
      background: var(--bg);
    }
    
    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-success {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-failure {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-in-progress {
      background: #fef3c7;
      color: #92400e;
    }
    
    .checkbox-col {
      width: 40px;
    }
    
    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
    }
    
    .app-checkbox-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: var(--bg);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logs-viewer {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .scheduled-job {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .theme-toggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
    }
    
    .toast {
      background: var(--card-bg);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .toast-success { border-left: 4px solid var(--success); }
    .toast-error { border-left: 4px solid var(--danger); }
    .toast-info { border-left: 4px solid var(--accent); }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo">üöÄ CI/CD Hub</div>
      
      <div class="team-selector">
        <label class="form-label" style="margin-bottom: 0.5rem;">Select Team</label>
        <select id="teamSelect" onchange="switchTeam()">
          <option value="">All Teams</option>
        </select>
      </div>
      
      <nav class="nav-section">
        <div class="nav-title">Views</div>
        <div class="nav-item active" onclick="showView('builds')">
          <span>üî®</span> Builds
          <span class="badge" id="buildsBadge">0</span>
        </div>
        <div class="nav-item" onclick="showView('releases')">
          <span>üöÄ</span> Releases
          <span class="badge" id="releasesBadge">0</span>
        </div>
        <div class="nav-item" onclick="showView('scheduled')">
          <span>‚è∞</span> Scheduled
        </div>
        <div class="nav-item" onclick="showView('pendingApprovals')">
          <span>‚úÖ</span> Pending Approvals
          <span class="badge" id="pendingBadge">0</span>
        </div>
      </nav>
      
      <nav class="nav-section">
        <div class="nav-title">Actions</div>
        <div class="nav-item" onclick="openModal('bulkBuildModal')">
          <span>‚ö°</span> Bulk Build
        </div>
        <div class="nav-item" onclick="openModal('bulkReleaseModal')">
          <span>üéØ</span> Bulk Release
        </div>
        <div class="nav-item" onclick="openModal('scheduleModal')">
          <span>üìÖ</span> Schedule Job
        </div>
      </nav>
    </aside>
    
    <header class="header">
      <div class="header-left">
        <div class="realtime-indicator">
          <div class="pulse"></div>
          <span>Real-time Updates</span>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-badge" onclick="toggleUserMenu()" style="cursor: pointer; position: relative;">
          <span>üë§</span>
          <span id="username">User</span>
          <span class="role-tag" id="userRole">Admin</span>
          <span style="margin-left: 0.5rem;">‚ñº</span>
          
          <!-- User Menu Dropdown -->
          <div id="userMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000;">
            <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
              <div style="font-weight: 600; margin-bottom: 0.25rem;" id="menuUsername">User</div>
              <div style="font-size: 0.8rem; color: var(--muted);" id="menuRole">Role</div>
            </div>
            <div id="userSwitcher" style="max-height: 200px; overflow-y: auto;"></div>
            <div style="padding: 0.5rem; border-top: 1px solid var(--border);">
              <button onclick="logout()" style="width: 100%; padding: 0.75rem; background: var(--danger); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                üö™ Logout
              </button>
            </div>
          </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
      </div>
    </header>
    
    <main class="main">
      <div id="buildsView">
        <h2 style="margin-bottom: 1.5rem;">Build Pipelines</h2>
        
        <div class="action-bar" style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
          <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Filter by App</label>
            <select id="buildAppFilter" class="form-input" style="padding: 0.5rem;" onchange="applyBuildFilters()">
              <option value="">All Apps</option>
            </select>
          </div>
          <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Filter by Branch</label>
            <select id="buildBranchFilter" class="form-input" style="padding: 0.5rem;" onchange="applyBuildFilters()">
              <option value="">All Branches</option>
            </select>
          </div>
          <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Filter by Status</label>
            <select id="buildStatusFilter" class="form-input" style="padding: 0.5rem;" onchange="applyBuildFilters()">
              <option value="">All Statuses</option>
              <option value="success">Success</option>
              <option value="failure">Failure</option>
              <option value="in_progress">In Progress</option>
              <option value="queued">Queued</option>
            </select>
          </div>
        </div>
        
        <div class="action-bar">
          <div class="action-controls">
            <button class="btn btn-primary" onclick="selectAllBuilds()">
              ‚òë Select All
            </button>
            <button class="btn btn-success" onclick="triggerSelectedBuilds()">
              ‚ñ∂ Trigger Selected
            </button>
            <button class="btn btn-danger" onclick="cancelSelectedBuilds()">
              ‚èπ Cancel Selected
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="checkbox-col"><input type="checkbox" class="checkbox" id="selectAllBuildsCheckbox" onchange="toggleAllBuilds()"></th>
                <th>App</th>
                <th>Version</th>
                <th>Branch</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Commit</th>
                <th>Time</th>
                <th style="min-width: 280px;">Jobs & Steps</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="buildsTable">
              <tr><td colspan="9" style="text-align: center; padding: 3rem; color: var(--muted);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div id="releasesView" style="display: none;">
        <h2 style="margin-bottom: 1.5rem;">Release Pipelines</h2>
        
        <div class="action-bar" style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
          <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Filter by App</label>
            <select id="releaseAppFilter" class="form-input" style="padding: 0.5rem;" onchange="applyReleaseFilters()">
              <option value="">All Apps</option>
            </select>
          </div>
          <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Filter by Branch</label>
            <select id="releaseBranchFilter" class="form-input" style="padding: 0.5rem;" onchange="applyReleaseFilters()">
              <option value="">All Branches</option>
            </select>
          </div>
          <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Filter by Status</label>
            <select id="releaseStatusFilter" class="form-input" style="padding: 0.5rem;" onchange="applyReleaseFilters()">
              <option value="">All Statuses</option>
              <option value="success">Success</option>
              <option value="failure">Failure</option>
              <option value="in_progress">In Progress</option>
              <option value="waiting">Waiting Approval</option>
            </select>
          </div>
        </div>
        
        <div class="action-bar">
          <div class="action-controls">
            <button class="btn btn-primary" onclick="selectAllReleases()">
              ‚òë Select All
            </button>
            <button class="btn btn-success" onclick="triggerSelectedReleases()">
              üöÄ Deploy Selected
            </button>
            <button class="btn btn-danger" onclick="cancelSelectedReleases()">
              ‚èπ Cancel Selected
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="checkbox-col"><input type="checkbox" class="checkbox" id="selectAllReleasesCheckbox" onchange="toggleAllReleases()"></th>
                <th>App</th>
                <th>Version</th>
                <th>Branch</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Time</th>
                <th style="min-width: 280px;">Jobs & Steps</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="releasesTable">
              <tr><td colspan="8" style="text-align: center; padding: 3rem; color: var(--muted);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div id="scheduledView" style="display: none;">
        <h2 style="margin-bottom: 1.5rem;">Scheduled Jobs</h2>
        <div id="scheduledJobsList"></div>
      </div>
      <div id="pendingApprovalsView" style="display: none;">
        <h2 style="margin-bottom: 1.5rem;">Pending Approvals</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>App</th>
                <th>Type</th>
                <th>Branch</th>
                <th>Version</th>
                <th>Status</th>
                <th>Triggered By</th>
                <th>Time</th>
                <th>Approvers</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingApprovalsTable">
              <tr><td colspan="9" style="text-align: center; padding: 3rem; color: var(--muted);">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <div id="bulkBuildModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Bulk Trigger Builds</h3>
        <button class="close-btn" onclick="closeModal('bulkBuildModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Common Branch (applies to all selected apps)</label>
          <select id="bulkBuildBranch" class="form-input" onchange="updateIndividualBranches('build')">
            <option value="">Select a branch</option>
          </select>
          <small style="color: var(--muted); margin-top: 0.25rem; display: block;">Or set individual branches per app below</small>
        </div>
        <div class="form-group">
          <label class="form-label">Select Apps & Individual Branches (optional)</label>
          <div id="bulkBuildAppsList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('bulkBuildModal')">Cancel</button>
        <button class="btn btn-success" onclick="executeBulkBuilds()">Trigger Builds</button>
      </div>
    </div>
  </div>
  
  <div id="bulkReleaseModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>Bulk Deploy Releases</h3>
        <button class="close-btn" onclick="closeModal('bulkReleaseModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Common Branch (applies to all selected apps)</label>
          <select id="bulkReleaseBranch" class="form-input" onchange="updateIndividualBranches('release')">
            <option value="">Select a branch</option>
          </select>
          <small style="color: var(--muted); margin-top: 0.25rem; display: block;">Or set individual branches per app below</small>
        </div>
        <div class="form-group">
          <label class="form-label">Select Apps & Individual Branches (optional)</label>
          <div id="bulkReleaseAppsList"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Version (optional)</label>
          <input type="text" class="form-input" id="releaseVersion" placeholder="e.g., v1.0.0 or 'latest'">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('bulkReleaseModal')">Cancel</button>
        <button class="btn btn-success" onclick="executeBulkReleases()">Deploy</button>
      </div>
    </div>
  </div>
  
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Schedule Workflow</h3>
        <button class="close-btn" onclick="closeModal('scheduleModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Workflow Type</label>
          <select class="form-input" id="scheduleType">
            <option value="build">Build</option>
            <option value="release">Release</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">App</label>
          <select class="form-input" id="scheduleApp"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Schedule Time</label>
          <input type="datetime-local" class="form-input" id="scheduleTime">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('scheduleModal')">Cancel</button>
        <button class="btn btn-primary" onclick="executeScheduleJob()">Schedule</button>
      </div>
    </div>
  </div>
  
  <div id="logsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3>Workflow Logs</h3>
        <button class="close-btn" onclick="closeModal('logsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="logs-viewer" id="logsViewer">Loading logs...</div>
      </div>
    </div>
  </div>
  
  <div class="toast-container" id="toastContainer"></div>
  
  <script>
    let currentTeam = '';
    let currentBranch = '';
    let dashboardData = { builds: [], releases: [], metrics: {}, teams: {} };
    let ws = null;
    let wsReconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let isAuthenticated = false;
    let wsReconnectTimer = null;
    let currentUser = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      initWebSocket();
      loadDashboard();
      loadScheduledJobs();
      
      const now = new Date();
      now.setHours(now.getHours() + 1);
      document.getElementById('scheduleTime').value = now.toISOString().slice(0, 16);
      
      // Close user menu when clicking outside
      document.addEventListener('click', (e) => {
        const userMenu = document.getElementById('userMenu');
        const userBadge = e.target.closest('.user-badge');
        if (!userBadge && userMenu && userMenu.style.display === 'block') {
          userMenu.style.display = 'none';
        }
      });
    });
    
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });
    
        if (!response.ok) {
          isAuthenticated = false;
          cleanupWebSocket();
          window.location.replace('/login.html');
          return;
        }
    
        const data = await response.json();
        isAuthenticated = true;
        loadUserInfo(data);
      } catch (err) {
        isAuthenticated = false;
        cleanupWebSocket();
        window.location.replace('/login.html');
  }
}
    
    async function loadUserInfo(userData = null) {
      try {
        let data = userData;
        if (!data) {
          const response = await fetch('/api/auth/me');
          data = await response.json();
        }
        
        currentUser = data; // Store current user globally
        
        document.getElementById('username').textContent = data.username;
        document.getElementById('userRole').textContent = data.role.charAt(0).toUpperCase() + data.role.slice(1);
        document.getElementById('menuUsername').textContent = data.username;
        document.getElementById('menuRole').textContent = `${data.role} ‚Ä¢ ${data.teams.join(', ')}`;
        
        // Show/hide pending approvals nav item based on role
        const pendingApprovalsNav = document.querySelector('.nav-item[onclick="showView(\'pendingApprovals\')"]');
        if (pendingApprovalsNav) {
          pendingApprovalsNav.style.display = (data.role === 'admin' || data.role === 'lead') ? 'flex' : 'none';
        }
        
        // Load user switcher (for admins)
        if (data.role === 'admin') {
          loadUserSwitcher();
        }
      } catch (err) {
        console.error('Load user info error:', err);
      }
    }
    
    async function loadUserSwitcher() {
      try {
        const response = await fetch('/api/auth/users');
        const data = await response.json();
        
        const html = data.users.map(user => `
          <div onclick="switchUser('${user.username}')" style="padding: 0.75rem 1rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
            <div style="font-weight: 500; margin-bottom: 0.25rem;">${user.username}</div>
            <div style="font-size: 0.75rem; color: var(--muted);">${user.role} ‚Ä¢ ${user.teams.join(', ')}</div>
          </div>
        `).join('');
        
        document.getElementById('userSwitcher').innerHTML = `
          <div style="padding: 0.5rem 1rem; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;">
            Switch User (Admin)
          </div>
          ${html}
        `;
      } catch (err) {
        console.error('Failed to load users:', err);
      }
    }
    
    function toggleUserMenu() {
      const menu = document.getElementById('userMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    
    async function switchUser(username) {
      try {
        const response = await fetch('/api/auth/switch-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        
        if (response.ok) {
          const data = await response.json();
          loadUserInfo(data.user);
          document.getElementById('userMenu').style.display = 'none';
          showToast(`Switched to ${username}`, 'success');
          loadDashboard(); // Reload dashboard with new user permissions
        }
      } catch (err) {
        showToast('Failed to switch user', 'error');
      }
    }
    
    async function logout() {
      try {
        isAuthenticated = false;
        cleanupWebSocket();
        
        // Call logout endpoint
        await fetch('/api/auth/logout', { 
          method: 'POST',
          credentials: 'include'
        });
    
        // Clear any client-side session data
        localStorage.clear();
        sessionStorage.clear();
    
        // Force hard reload to root
        window.location.replace('/');
    
      } catch (err) {
        console.error('Logout error:', err);
        // Still redirect even if fetch fails
        window.location.replace('/');
      }
    }
    function cleanupWebSocket() {
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }
      if (ws) {
        ws.onclose = null; // Prevent reconnection
        ws.close();
        ws = null;
      }
      wsReconnectAttempts = 0;
    }
    
    function initWebSocket() {
      // Don't reconnect if not authenticated or max attempts reached
      if (!isAuthenticated || wsReconnectAttempts >= maxReconnectAttempts) {
        console.log('WebSocket connection skipped - not authenticated or max attempts reached');
        return;
      }
      
      // Clean up existing connection
      if (ws && ws.readyState === WebSocket.OPEN) {
        return; // Already connected
      }
      
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);
      
      ws.onopen = () => {
        console.log('WebSocket connected');
        wsReconnectAttempts = 0; // Reset counter on successful connection
        showToast('Connected to real-time updates', 'success');
        
        // Authenticate WebSocket with current user
        fetch('/api/auth/me')
          .then(r => r.json())
          .then(data => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: 'auth', username: data.username }));
            }
          })
          .catch(err => {
            console.error('WebSocket auth error:', err);
            cleanupWebSocket();
          });
      };
      
      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleRealtimeUpdate(message);
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = () => {
        console.log('WebSocket disconnected');
        ws = null;
        
        // Only reconnect if authenticated and haven't exceeded max attempts
        if (isAuthenticated && wsReconnectAttempts < maxReconnectAttempts) {
          wsReconnectAttempts++;
          const delay = Math.min(5000 * wsReconnectAttempts, 30000); // Exponential backoff, max 30s
          console.log(`Reconnecting WebSocket in ${delay/1000}s (attempt ${wsReconnectAttempts}/${maxReconnectAttempts})`);
          wsReconnectTimer = setTimeout(initWebSocket, delay);
        } else {
          console.log('WebSocket reconnection stopped');
        }
      };
    }
    
    function handleRealtimeUpdate(message) {
      console.log('Real-time update:', message);
      
      switch(message.type) {
        case 'workflow_update':
          // Only reload if there are actual changes
          if (message.data && (message.data.builds?.length > 0 || message.data.releases?.length > 0)) {
            loadDashboard();
          }
          break;
        case 'workflow_triggered':
          showToast(`Workflow triggered by ${message.data.user}`, 'success');
          setTimeout(loadDashboard, 2000);
          break;
        case 'bulk_builds_triggered':
        case 'bulk_releases_triggered':
          showToast(`Bulk operation completed`, 'success');
          setTimeout(loadDashboard, 2000);
          break;
      }
    }
    
    async function loadDashboard() {
      try {
        const params = new URLSearchParams();
        if (currentTeam) params.append('team', currentTeam);
        if (currentBranch) params.append('branch', currentBranch);
        
        console.log(`Loading dashboard - Team: ${currentTeam || 'All'}, Branch: ${currentBranch || 'All'}`);
        
        const response = await fetch(`/api/dashboard?${params}`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            isAuthenticated = false;
            cleanupWebSocket();
            window.location.replace('/login.html');
            return;
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to load dashboard');
        }
        
        dashboardData = await response.json();
        
        // Ensure dashboardData has required properties
        if (!dashboardData.builds) dashboardData.builds = [];
        if (!dashboardData.releases) dashboardData.releases = [];
        if (!dashboardData.teams) dashboardData.teams = {};
        if (!dashboardData.metrics) dashboardData.metrics = {};
        
        renderDashboard();
        renderBranches();
        renderTeams();
      } catch (err) {
        console.error('Load dashboard error:', err);
        showToast(err.message || 'Failed to load dashboard', 'error');
      }
    }
    
    // function loadUserInfo() {
    //   document.getElementById('username').textContent = 'user1';
    //   document.getElementById('userRole').textContent = 'Admin';
    // }
    
    async function approveRelease(repo, runId, appName) {
      if (!confirm(`Approve release for ${appName}?\n\nThis will approve the pending deployment and allow it to proceed.`)) {
        return;
      }
      
      try {
        // Find which team this app belongs to
        let appTeam = null;
        for (const [teamName, teamConfig] of Object.entries(dashboardData.teams || {})) {
          if (teamConfig.apps && teamConfig.apps.includes(appName)) {
            appTeam = teamName;
            break;
          }
        }
        
        if (!appTeam) {
          showToast('Cannot determine team for this app', 'error');
          return;
        }
        
        showToast('Approving deployment...', 'info');
        
        const response = await fetch('/api/workflow/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ repo, runId, team: appTeam })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to approve deployment');
        }
        
        const envs = data.environments ? ` (${data.environments.join(', ')})` : '';
        showToast(`Deployment approved successfully${envs}`, 'success');
        
        // Refresh dashboard to update status
        setTimeout(() => loadDashboard(), 2000);
      } catch (err) {
        console.error('Approval error:', err);
        showToast(err.message || 'Failed to approve deployment', 'error');
      }
    }
    
    async function loadScheduledJobs() {
      try {
        const response = await fetch('/api/schedule/list', {
          credentials: 'include'
        });
        const data = await response.json();
        renderScheduledJobs(data.scheduledJobs || []);
      } catch (err) {
        console.error('Load scheduled jobs error:', err);
      }
    }
    
    function renderDashboard() {
      console.log(`Rendering dashboard - Team: ${currentTeam || 'All'}, Builds: ${dashboardData.builds.length}, Releases: ${dashboardData.releases.length}`);
      console.log('Build apps:', dashboardData.builds.map(b => b.appName).join(', '));
      console.log('Release apps:', dashboardData.releases.map(r => r.appName).join(', '));
      
      // Update badges in navigation
      document.getElementById('buildsBadge').textContent = dashboardData.builds.filter(b => b.conclusion === 'failure').length;
      document.getElementById('releasesBadge').textContent = dashboardData.releases.filter(r => r.conclusion === 'failure').length;
      
      // Reset filtered data arrays to force fresh rendering
      filteredBuildsData = [];
      filteredReleasesData = [];
      
      // Ensure builds view is visible after team change
      const buildsView = document.getElementById('buildsView');
      if (buildsView && buildsView.style.display === 'none') {
        const currentView = document.querySelector('.nav-item.active');
        if (currentView && currentView.textContent.includes('Builds')) {
          buildsView.style.display = 'block';
        }
      }
      
      // Render tables with fresh data (no filters applied initially)
      renderBuildsTable();
      renderReleasesTable();
      
      // Only render pending approvals if user has permission
      if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'lead')) {
        renderPendingApprovals();
      }
    }
    
function renderPendingApprovals() {
  try {
    const pending = (dashboardData.releases || [])
      .filter(r => {
        // GitHub Actions uses 'waiting' status for runs waiting for approval
        // Also check for 'action_required' and jobs with 'waiting' status
        const isWaitingStatus = r.status === 'waiting' || r.status === 'action_required';
        const hasWaitingJobs = r.jobs?.some(job => job.status === 'waiting' || job.status === 'pending');
        const isPendingConclusion = r.conclusion === 'action_required' || r.conclusion === 'waiting';
        
        return isWaitingStatus || hasWaitingJobs || isPendingConclusion;
      })
      .map(release => {
        // üîç Find teams owning this app
        const appTeams = Object.entries(dashboardData.teams || {})
          .filter(([_, team]) => Array.isArray(team.apps) && team.apps.includes(release.appName))
          .map(([teamName]) => teamName);

        // üë• Resolve approvers from roles (if USER_ROLES is available)
        let approvers = 'Approval Required';
        if (typeof USER_ROLES !== 'undefined' && appTeams.length > 0) {
          const approversList = appTeams.flatMap(teamName => {
            const team = dashboardData.teams?.[teamName];
            if (!team || !team.permissions?.approve_release) return [];

            return Object.entries(USER_ROLES || {})
              .filter(([_, user]) =>
                Array.isArray(user.teams) &&
                user.teams.includes(teamName) &&
                team.permissions.approve_release.includes(user.role)
              )
              .map(([username]) => username);
          });
          
          approvers = [...new Set(approversList)].join(', ') || 'No approvers configured';
        }

        return {
          ...release,
          approvers: approvers
        };
      });

    const html = pending.map(item => `
      <tr>
        <td><strong>${item.appName}</strong></td>
        <td>${item.type}</td>
        <td>${item.branch}</td>
        <td><code>${item.version}</code></td>
        <td>${getStatusBadge(item.conclusion || item.status)}</td>
        <td>${item.triggeredBy || '-'}</td>
        <td>${item.createdAt ? new Date(item.createdAt).toLocaleString() : '-'}</td>
        <td>${item.approvers}</td>
        <td>
          ${
            currentUser && (currentUser.role === 'admin' || currentUser.role === 'lead')
              ? `<button
                   class="btn btn-success"
                   style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 0.5rem;"
                   onclick="approveRelease('${item.repo}', '${item.runId}', '${item.appName}')">
                   ‚úÖ Approve
                 </button>`
              : ''
          }
          <button
            class="btn btn-secondary"
            style="padding: 0.4rem 0.8rem; font-size: 0.8rem;"
            onclick="viewLogs('${item.repo}', '${item.runId}')">
            üìã Logs
          </button>
          ${
            item.link
              ? `<a href="${item.link}" target="_blank"
                   class="btn btn-secondary"
                   style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-left: 0.5rem; text-decoration: none;">
                   üîó GitHub
                 </a>`
              : ''
          }
        </td>
      </tr>
    `).join('');

    document.getElementById('pendingApprovalsTable').innerHTML =
      html || '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No pending approvals</td></tr>';

    // üîî Badge update
    document.getElementById('pendingBadge').textContent = pending.length;
  } catch (err) {
    console.error('Error rendering pending approvals:', err);
    document.getElementById('pendingApprovalsTable').innerHTML = 
      '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: var(--danger);">Error loading pending approvals</td></tr>';
    document.getElementById('pendingBadge').textContent = 0;
  }
}

    function renderBranches() {
      let branches = [];
      
      try {
        if (currentTeam && dashboardData.teams && dashboardData.teams[currentTeam]) {
          // Show team-specific branches
          branches = dashboardData.teams[currentTeam].branches || [];
        } else if (dashboardData.builds && dashboardData.releases) {
          // Show all unique branches from builds and releases
          const allBranches = [...new Set([
            ...(dashboardData.builds || []).map(b => b.branch),
            ...(dashboardData.releases || []).map(r => r.branch)
          ].filter(b => b && b !== 'N/A'))];
          branches = allBranches;
        }
        
        // Update main branch filter dropdown
        const options = ['<option value="">All Branches</option>'].concat(
          branches.map(branch => `<option value="${branch}" ${currentBranch === branch ? 'selected' : ''}>${branch}</option>`)
        );
        const branchSelect = document.getElementById('branchSelect');
        if (branchSelect) {
          branchSelect.innerHTML = options.join('');
        }
        
        // Update modal branch dropdowns
        const modalOptions = ['<option value="">Select a branch</option>'].concat(
          branches.map(branch => `<option value="${branch}">${branch}</option>`)
        );
        const buildBranch = document.getElementById('bulkBuildBranch');
        const releaseBranch = document.getElementById('bulkReleaseBranch');
        if (buildBranch) buildBranch.innerHTML = modalOptions.join('');
        if (releaseBranch) releaseBranch.innerHTML = modalOptions.join('');
      } catch (err) {
        console.error('Error rendering branches:', err);
      }
    }
    
    function renderTeams() {
      const teams = Object.keys(dashboardData.teams || {});
      console.log('Available teams for user:', teams);
      
      // Only show "All Teams" if user has multiple teams, otherwise select the only team
      let options = [];
      if (teams.length > 1) {
        options.push('<option value="">All Teams</option>');
      }
      
      options = options.concat(
        teams.map(team => `<option value="${team}" ${currentTeam === team ? 'selected' : ''}>${dashboardData.teams[team].name}</option>`)
      );
      
      document.getElementById('teamSelect').innerHTML = options.join('');
      
      // If user only has one team, auto-select it
      if (teams.length === 1 && !currentTeam) {
        currentTeam = teams[0];
        document.getElementById('teamSelect').value = currentTeam;
        console.log('Auto-selected single team:', currentTeam);
      }
      
      const teamApps = currentTeam && dashboardData.teams[currentTeam] 
        ? dashboardData.teams[currentTeam].apps 
        : [...new Set([...dashboardData.builds, ...dashboardData.releases].map(i => i.appName))];
      
      renderAppCheckboxes(teamApps);
    }
    
    function renderAppCheckboxes(apps) {
      // Get available branches
      let branches = [];
      if (currentTeam && dashboardData.teams && dashboardData.teams[currentTeam]) {
        branches = dashboardData.teams[currentTeam].branches || [];
      } else if (dashboardData.builds && dashboardData.releases) {
        branches = [...new Set([
          ...(dashboardData.builds || []).map(b => b.branch),
          ...(dashboardData.releases || []).map(r => r.branch)
        ].filter(b => b && b !== 'N/A'))];
      }
      
      const branchOptions = branches.map(b => `<option value="${b}">${b}</option>`).join('');
      
      const buildHtml = apps.map(app => 
        `<div class="app-checkbox-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <input type="checkbox" class="checkbox" value="${app}" id="build-${app}">
          <label for="build-${app}" style="flex: 1; margin: 0;">${app}</label>
          <select class="form-input app-branch-select" data-app="${app}" style="width: 150px; padding: 0.3rem;">
            <option value="">Use common branch</option>
            ${branchOptions}
          </select>
        </div>`
      ).join('');
      document.getElementById('bulkBuildAppsList').innerHTML = buildHtml;
      
      const releaseHtml = apps.map(app => 
        `<div class="app-checkbox-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <input type="checkbox" class="checkbox" value="${app}" id="release-${app}">
          <label for="release-${app}" style="flex: 1; margin: 0;">${app}</label>
          <select class="form-input app-branch-select" data-app="${app}" style="width: 150px; padding: 0.3rem;">
            <option value="">Use common branch</option>
            ${branchOptions}
          </select>
        </div>`
      ).join('');
      document.getElementById('bulkReleaseAppsList').innerHTML = releaseHtml;
      
      const scheduleOptions = apps.map(app => `<option value="${app}">${app}</option>`).join('');
      document.getElementById('scheduleApp').innerHTML = scheduleOptions;
      
      // Populate app filters for builds and releases views
      const appOptions = apps.map(app => `<option value="${app}">${app}</option>`).join('');
      const buildFilter = document.getElementById('buildAppFilter');
      const releaseFilter = document.getElementById('releaseAppFilter');
      if (buildFilter) buildFilter.innerHTML = '<option value="">All Apps</option>' + appOptions;
      if (releaseFilter) releaseFilter.innerHTML = '<option value="">All Apps</option>' + appOptions;
      
      // Populate branch filters for builds and releases views
      const buildBranchFilter = document.getElementById('buildBranchFilter');
      const releaseBranchFilter = document.getElementById('releaseBranchFilter');
      if (buildBranchFilter) buildBranchFilter.innerHTML = '<option value="">All Branches</option>' + branchOptions;
      if (releaseBranchFilter) releaseBranchFilter.innerHTML = '<option value="">All Branches</option>' + branchOptions;
    }
    
    function updateIndividualBranches(type) {
      const commonBranch = document.getElementById(type === 'build' ? 'bulkBuildBranch' : 'bulkReleaseBranch').value;
      if (commonBranch) {
        const selects = document.querySelectorAll(`#bulk${type === 'build' ? 'Build' : 'Release'}AppsList .app-branch-select`);
        selects.forEach(select => {
          if (select.value === '') {
            // Only update if user hasn't selected individual branch
            select.value = commonBranch;
          }
        });
      }
    }
    
    // Filter functions for builds and releases tables
    let filteredBuildsData = [];
    let filteredReleasesData = [];
    
    function applyBuildFilters() {
      const appFilter = document.getElementById('buildAppFilter')?.value || '';
      const branchFilter = document.getElementById('buildBranchFilter')?.value || '';
      const statusFilter = document.getElementById('buildStatusFilter')?.value || '';
      
      // Note: dashboardData.builds is already filtered by team from the backend
      filteredBuildsData = dashboardData.builds.filter(build => {
        const appMatch = !appFilter || build.appName === appFilter;
        const branchMatch = !branchFilter || build.branch === branchFilter;
        const statusMatch = !statusFilter || build.conclusion === statusFilter || build.status === statusFilter;
        return appMatch && branchMatch && statusMatch;
      });
      
      console.log(`Build filters applied - App: ${appFilter || 'All'}, Branch: ${branchFilter || 'All'}, Status: ${statusFilter || 'All'}, Results: ${filteredBuildsData.length}`);
      renderBuildsTable(filteredBuildsData);
    }
    
    function applyReleaseFilters() {
      const appFilter = document.getElementById('releaseAppFilter')?.value || '';
      const branchFilter = document.getElementById('releaseBranchFilter')?.value || '';
      const statusFilter = document.getElementById('releaseStatusFilter')?.value || '';
      
      // Note: dashboardData.releases is already filtered by team from the backend
      filteredReleasesData = dashboardData.releases.filter(release => {
        const appMatch = !appFilter || release.appName === appFilter;
        const branchMatch = !branchFilter || release.branch === branchFilter;
        const statusMatch = !statusFilter || release.conclusion === statusFilter || release.status === statusFilter;
        return appMatch && branchMatch && statusMatch;
      });
      
      console.log(`Release filters applied - App: ${appFilter || 'All'}, Branch: ${branchFilter || 'All'}, Status: ${statusFilter || 'All'}, Results: ${filteredReleasesData.length}`);
      renderReleasesTable(filteredReleasesData);
    }
    
    // Helper function to render step statuses with clickable links
    function renderStepStatuses(steps, jobUrl) {
      if (!steps?.length) return '<div style="color:#9ca3af; font-size:0.8rem; padding:4px;">No steps available</div>';

      return steps.map(step => {
        let color = '#6b7280', symbol = '‚óã', bg = '#f3f4f6';
        if (step.status === 'in_progress') {
          color = '#eab308'; symbol = '‚ü≥'; bg = '#fef3c7';
        } else if (step.conclusion === 'success') {
          color = '#22c55e'; symbol = '‚úì'; bg = '#dcfce7';
        } else if (step.conclusion === 'failure') {
          color = '#ef4444'; symbol = '‚úó'; bg = '#fee2e2';
        } else if (step.conclusion === 'skipped') {
          color = '#9ca3af'; symbol = '‚äò'; bg = '#f3f4f6';
        }

        const stepAnchor = `${jobUrl}#step:${step.number}:1`;
        const isClickable = step.conclusion === 'failure' || step.status === 'in_progress';

        return `
          <div style="display:flex; align-items:center; padding:4px 8px; margin:3px 0; background:${bg}; border-radius:6px; font-size:0.8rem; border:1px solid #e5e7eb;">
            <span style="color:${color}; font-weight:bold; margin-right:6px;">${symbol}</span>
            ${isClickable ?
              `<a href="${stepAnchor}" target="_blank" rel="noopener noreferrer" style="color:#000; text-decoration:none; flex:1; display:flex; align-items:center;" title="View logs for this step">
                <span style="flex:1;">${step.number}. ${step.name}</span>
                <span style="margin-left:8px; font-size:0.7rem; opacity:0.6;">üîó</span>
              </a>` :
              `<span style="color:#000;">${step.number}. ${step.name}</span>`
            }
          </div>
        `;
      }).join('');
    }

    // Helper function to render job statuses with expandable step details
    function renderJobStatuses(jobs) {
      if (!jobs?.length) return '<div style="color:#9ca3af; padding:8px;">No jobs</div>';

      return `
        <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center; padding:4px;">
          ${jobs.map((job, idx) => {
            let color = '#6b7280', symbol = '‚óã', bg = '#f3f4f6', borderColor = '#d1d5db';
            if (job.status === 'in_progress' || job.status === 'queued') {
              color = '#eab308'; symbol = '‚ü≥'; bg = '#fef3c7'; borderColor = '#f59e0b';
            } else if (job.conclusion === 'success') {
              color = '#22c55e'; symbol = '‚úì'; bg = '#dcfce7'; borderColor = '#22c55e';
            } else if (job.conclusion === 'failure' || job.conclusion === 'cancelled') {
              color = '#ef4444'; symbol = '‚úó'; bg = '#fee2e2'; borderColor = '#ef4444';
            }

            const jobId = `job-${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
            const stepCount = job.steps?.length || 0;
            const hasFailedSteps = job.steps?.some(s => s.conclusion === 'failure');

            return `
              <div style="position:relative;">
                <div onclick="toggleJobSteps('${jobId}')"
                     title="${job.name} ‚Ä¢ ${job.duration || 'N/A'} ‚Ä¢ ${stepCount} steps ‚Ä¢ Click to expand"
                     style="cursor:pointer; padding:5px 10px; background:${bg}; border-radius:6px; border:2px solid ${borderColor}; display:flex; align-items:center; gap:6px; font-size:0.82rem; white-space:nowrap; transition: all 0.2s;">
                  <span style="color:${color}; font-weight:bold;">${symbol}</span>
                  <span style="font-weight:500; color:#000;">${job.name}</span>
                  ${stepCount ? `<small style="color:#6b7280;">(${stepCount})</small>` : ''}
                  ${hasFailedSteps ? `<span style="color:#ef4444; font-size:0.7rem;">‚ö†</span>` : ''}
                </div>
                <div id="${jobId}" style="display:none; position:absolute; z-index:20; background:white; border:2px solid ${borderColor}; border-radius:8px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.25); min-width:380px; max-width:580px; margin-top:8px; padding:12px; max-height:420px; overflow-y:auto; left:0;">
                  <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                    <div style="flex:1;">
                      <div style="font-weight:600; margin-bottom:4px; color:#1f2937; font-size:0.95rem;">${job.name}</div>
                      <div style="font-size:0.82rem; color:#4b5563;">
                        ${job.duration || 'N/A'} ‚Ä¢ ${job.status}${job.conclusion ? ` ‚Üí ${job.conclusion}` : ''}
                      </div>
                    </div>
                    <a href="${job.htmlUrl}" target="_blank" rel="noopener noreferrer"
                       style="background:#3b82f6; color:white; padding:6px 12px; border-radius:6px; font-size:0.8rem; text-decoration:none; white-space:nowrap; margin-left:8px;"
                       title="View full job logs on GitHub">
                      View Logs ‚Üí
                    </a>
                  </div>
                  <div style="border-top:1px solid #e5e7eb; padding-top:10px;">
                    ${renderStepStatuses(job.steps, job.htmlUrl)}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Toggle job steps visibility
    function toggleJobSteps(jobId) {
      // Close all other job popups
      document.querySelectorAll('[id^="job-"]').forEach(el => {
        if (el.id !== jobId) el.style.display = 'none';
      });
      // Toggle clicked job
      const el = document.getElementById(jobId);
      if (el) {
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
      }
    }

    // Close job popups when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('[id^="job-"]') && !e.target.closest('[onclick^="toggleJobSteps"]')) {
        document.querySelectorAll('[id^="job-"]').forEach(el => {
          el.style.display = 'none';
        });
      }
    });

    function renderBuildsTable(builds = null) {
      const dataToRender = builds || dashboardData.builds;
      const html = dataToRender.map((build, idx) => `
        <tr>
          <td><input type="checkbox" class="checkbox build-checkbox" data-index="${idx}"></td>
          <td><strong>${build.appName}</strong></td>
          <td><code>${build.version}</code></td>
          <td>${build.branch}</td>
          <td>${getStatusBadge(build.conclusion || build.status)}</td>
          <td>${build.duration}</td>
          <td><code>${build.commitSha}</code></td>
          <td>${new Date(build.createdAt).toLocaleString()}</td>
          <td style="min-width:280px; max-width:500px;">${renderJobStatuses(build.jobs)}</td>
          <td>
            <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="viewLogs('${build.repo}', '${build.runId}')">
              üìã Logs
            </button>
            ${build.link ? `
          <a href="${build.link}" target="_blank" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-left: 0.5rem; text-decoration: none;">
            üîó GitHub Run
          </a>
        ` : ''}
            ${build.status === 'in_progress' ? 
              `<button class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-left: 0.5rem;" onclick="cancelWorkflow('${build.repo}', '${build.runId}')">
                ‚èπ Cancel
              </button>` : ''}
          </td>
        </tr>
      `).join('');
      
      document.getElementById('buildsTable').innerHTML = html || '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No builds found</td></tr>';
    }
    
    function renderReleasesTable(releases = null) {
      const dataToRender = releases || dashboardData.releases;
      const html = dataToRender.map((release, idx) => `
        <tr>
          <td><input type="checkbox" class="checkbox release-checkbox" data-index="${idx}"></td>
          <td><strong>${release.appName}</strong></td>
          <td><code>${release.version}</code></td>
          <td>${release.branch}</td>
          <td>${getStatusBadge(release.conclusion || release.status)}</td>
          <td>${release.duration}</td>
          <td>${new Date(release.createdAt).toLocaleString()}</td>
          <td style="min-width:280px; max-width:500px;">${renderJobStatuses(release.jobs)}</td>
          <td>
            <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="viewLogs('${release.repo}', '${release.runId}')">
              üìã Logs
            </button>
            ${release.link ? `
          <a href="${release.link}" target="_blank" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-left: 0.5rem; text-decoration: none;">
            üîó GitHub Run
          </a>
        ` : ''}
            ${release.status === 'waiting' ? 
              `<button class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-left: 0.5rem;" onclick="cancelWorkflow('${release.repo}', '${release.runId}')">
                ‚èπ Cancel
              </button>` : ''}
          </td>
        </tr>
      `).join('');
      
      document.getElementById('releasesTable').innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No releases found</td></tr>';
    }
    
    function renderScheduledJobs(jobs) {
      const html = jobs.map(job => `
        <div class="scheduled-job">
          <div>
            <strong>${job.repo}</strong> - ${job.workflowId}<br>
            <small style="color: var(--muted);">Scheduled for: ${new Date(job.scheduledTime).toLocaleString()}</small>
          </div>
          <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="cancelScheduledJob('${job.id}')">
            Cancel
          </button>
        </div>
      `).join('');
      
      document.getElementById('scheduledJobsList').innerHTML = html || '<p style="color: var(--muted); text-align: center; padding: 2rem;">No scheduled jobs</p>';
    }
    
    function getStatusBadge(status) {
      const statusMap = {
        'success': 'status-success',
        'completed': 'status-success',
        'failure': 'status-failure',
        'failed': 'status-failure',
        'in_progress': 'status-in-progress',
        'queued': 'status-in-progress'
      };
      
      const className = statusMap[status] || 'status-in-progress';
      return `<span class="status-badge ${className}">${status}</span>`;
    }
    
    function switchTeam() {
      try {
        console.log('switchTeam function called');
        
        const teamSelect = document.getElementById('teamSelect');
        if (!teamSelect) {
          console.error('teamSelect element not found!');
          return;
        }
        
        currentTeam = teamSelect.value;
        console.log(`Team selected: "${currentTeam}"`);
        
        currentBranch = ''; // Reset branch when changing team
        const branchSelect = document.getElementById('branchSelect');
        if (branchSelect) branchSelect.value = ''; // Reset dropdown
        
        // Reset all filters when team changes
        const buildAppFilter = document.getElementById('buildAppFilter');
        const buildBranchFilter = document.getElementById('buildBranchFilter');
        const buildStatusFilter = document.getElementById('buildStatusFilter');
        const releaseAppFilter = document.getElementById('releaseAppFilter');
        const releaseBranchFilter = document.getElementById('releaseBranchFilter');
        const releaseStatusFilter = document.getElementById('releaseStatusFilter');
        
        if (buildAppFilter) buildAppFilter.value = '';
        if (buildBranchFilter) buildBranchFilter.value = '';
        if (buildStatusFilter) buildStatusFilter.value = '';
        if (releaseAppFilter) releaseAppFilter.value = '';
        if (releaseBranchFilter) releaseBranchFilter.value = '';
        if (releaseStatusFilter) releaseStatusFilter.value = '';
        
        // Reset filtered data arrays
        filteredBuildsData = [];
        filteredReleasesData = [];
        
        // Clear current table data immediately
        const buildsTable = document.getElementById('buildsTable');
        const releasesTable = document.getElementById('releasesTable');
        if (buildsTable) {
          buildsTable.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #6b7280;">Loading team data...</td></tr>';
          console.log('Builds table cleared');
        }
        if (releasesTable) {
          releasesTable.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #6b7280;">Loading team data...</td></tr>';
          console.log('Releases table cleared');
        }
        
        console.log(`Calling loadDashboard with team: ${currentTeam || 'All'}`);
        
        // Load dashboard data which will trigger re-rendering of tables
        loadDashboard();
      } catch (error) {
        console.error('Error in switchTeam:', error);
        showToast('Failed to switch team: ' + error.message, 'error');
      }
    }
    
    function switchBranch() {
      currentBranch = document.getElementById('branchSelect').value;
      loadDashboard();
    }
    
    function refreshDashboard() {
      loadDashboard();
      showToast('Dashboard refreshed', 'success');
    }
    
    function showView(view) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      document.getElementById('buildsView').style.display = view === 'builds' ? 'block' : 'none';
      document.getElementById('releasesView').style.display = view === 'releases' ? 'block' : 'none';
      document.getElementById('scheduledView').style.display = view === 'scheduled' ? 'block' : 'none';
      document.getElementById('pendingApprovalsView').style.display = view === 'pendingApprovals' ? 'block' : 'none';
      
      if (view === 'scheduled') {
        loadScheduledJobs();
      }
    }
    
    function openModal(modalId) {
      // Ensure branches are populated in modals
      if (modalId === 'bulkBuildModal' || modalId === 'bulkReleaseModal') {
        renderBranches();
      }
      document.getElementById(modalId).classList.add('active');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    function toggleAllBuilds() {
      const checked = document.getElementById('selectAllBuildsCheckbox').checked;
      document.querySelectorAll('.build-checkbox').forEach(cb => cb.checked = checked);
    }
    
    function toggleAllReleases() {
      const checked = document.getElementById('selectAllReleasesCheckbox').checked;
      document.querySelectorAll('.release-checkbox').forEach(cb => cb.checked = checked);
    }
    
    function selectAllBuilds() {
      document.getElementById('selectAllBuildsCheckbox').checked = true;
      toggleAllBuilds();
    }
    
    function selectAllReleases() {
      document.getElementById('selectAllReleasesCheckbox').checked = true;
      toggleAllReleases();
    }
    
    async function executeBulkBuilds() {
      const selectedCheckboxes = document.querySelectorAll('#bulkBuildAppsList input:checked');
      const commonBranch = document.getElementById('bulkBuildBranch').value;
      
      if (selectedCheckboxes.length === 0) {
        showToast('Please select at least one app', 'error');
        return;
      }
      
      if (!currentTeam) {
        showToast('Please select a team first', 'error');
        return;
      }
      
      // Build app-branch mapping
      const appBranches = [];
      let hasError = false;
      
      selectedCheckboxes.forEach(cb => {
        const app = cb.value;
        const branchSelect = document.querySelector(`#bulkBuildAppsList .app-branch-select[data-app="${app}"]`);
        const individualBranch = branchSelect?.value || '';
        const branch = individualBranch || commonBranch;
        
        if (!branch) {
          showToast(`Please select a branch for ${app} or set a common branch`, 'error');
          hasError = true;
          return;
        }
        
        appBranches.push({ app, branch });
      });
      
      if (hasError) return;
      
      try {
        // Trigger each app with its specific branch
        const results = [];
        for (const { app, branch } of appBranches) {
          const response = await fetch('/api/trigger/bulk-builds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              apps: [app],
              branch: branch,
              team: currentTeam
            })
          });
          
          if (response.ok) {
            results.push({ app, branch, success: true });
          } else {
            const error = await response.json();
            results.push({ app, branch, success: false, error: error.error });
          }
        }
        
        closeModal('bulkBuildModal');
        const successCount = results.filter(r => r.success).length;
        const failCount = results.length - successCount;
        
        if (failCount === 0) {
          showToast(`‚úÖ Triggered builds for ${successCount} apps`, 'success');
        } else {
          showToast(`‚ö†Ô∏è ${successCount} succeeded, ${failCount} failed`, 'warning');
        }
        
        setTimeout(loadDashboard, 2000);
      } catch (err) {
        console.error('Bulk build error:', err);
        showToast(err.message || 'Failed to trigger builds', 'error');
      }
    }
    
    async function executeBulkReleases() {
      const selectedCheckboxes = document.querySelectorAll('#bulkReleaseAppsList input:checked');
      const commonBranch = document.getElementById('bulkReleaseBranch').value;
      const version = document.getElementById('releaseVersion').value || 'latest';
      
      if (selectedCheckboxes.length === 0) {
        showToast('Please select at least one app', 'error');
        return;
      }
      
      if (!currentTeam) {
        showToast('Please select a team first', 'error');
        return;
      }
      
      // Build app-branch mapping
      const appBranches = [];
      let hasError = false;
      
      selectedCheckboxes.forEach(cb => {
        const app = cb.value;
        const branchSelect = document.querySelector(`#bulkReleaseAppsList .app-branch-select[data-app="${app}"]`);
        const individualBranch = branchSelect?.value || '';
        const branch = individualBranch || commonBranch;
        
        if (!branch) {
          showToast(`Please select a branch for ${app} or set a common branch`, 'error');
          hasError = true;
          return;
        }
        
        appBranches.push({ app, branch });
      });
      
      if (hasError) return;
      
      try {
        // Trigger each app with its specific branch
        const results = [];
        for (const { app, branch } of appBranches) {
          const response = await fetch('/api/trigger/bulk-releases', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              apps: [app],
              branch: branch,
              team: currentTeam,
              version
            })
          });
          
          if (response.ok) {
            results.push({ app, branch, success: true });
          } else {
            const error = await response.json();
            results.push({ app, branch, success: false, error: error.error });
          }
        }
        
        closeModal('bulkReleaseModal');
        const successCount = results.filter(r => r.success).length;
        const failCount = results.length - successCount;
        
        if (failCount === 0) {
          showToast(`‚úÖ Triggered releases for ${successCount} apps`, 'success');
        } else {
          showToast(`‚ö†Ô∏è ${successCount} succeeded, ${failCount} failed`, 'warning');
        }
        
        setTimeout(loadDashboard, 2000);
      } catch (err) {
        console.error('Bulk release error:', err);
        showToast(err.message || 'Failed to trigger releases', 'error');
      }
    }

    
    async function triggerSelectedBuilds() {
      const selected = Array.from(document.querySelectorAll('.build-checkbox:checked'))
        .map(cb => dashboardData.builds[cb.dataset.index]);
      
      if (selected.length === 0) {
        showToast('Please select builds to trigger', 'error');
        return;
      }
      
      const apps = [...new Set(selected.map(b => b.appName))];
      
      try {
        const response = await fetch('/api/trigger/bulk-builds', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User': 'user1'
          },
          body: JSON.stringify({
            apps,
            branch: currentBranch || 'main',
            team: currentTeam
          })
        });
        
        showToast(`Triggered ${apps.length} builds`, 'success');
        setTimeout(loadDashboard, 2000);
      } catch (err) {
        showToast('Failed to trigger builds', 'error');
      }
    }
    
    async function triggerSelectedReleases() {
      const selected = Array.from(document.querySelectorAll('.release-checkbox:checked'))
        .map(cb => dashboardData.releases[cb.dataset.index]);
      
      if (selected.length === 0) {
        showToast('Please select releases to trigger', 'error');
        return;
      }
      
      const apps = [...new Set(selected.map(r => r.appName))];
      
      try {
        const response = await fetch('/api/trigger/bulk-releases', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User': 'user1'
          },
          body: JSON.stringify({
            apps,
            branch: currentBranch || 'main',
            team: currentTeam,
            version: 'latest'
          })
        });
        
        showToast(`Triggered ${apps.length} releases`, 'success');
        setTimeout(loadDashboard, 2000);
      } catch (err) {
        showToast('Failed to trigger releases', 'error');
      }
    }
    
    async function cancelSelectedBuilds() {
      const selected = Array.from(document.querySelectorAll('.build-checkbox:checked'))
        .map(cb => dashboardData.builds[cb.dataset.index])
        .filter(b => b.status === 'in_progress' || b.status === 'queued');
      
      if (selected.length === 0) {
        showToast('No running builds selected', 'error');
        return;
      }
      
      for (const build of selected) {
        await cancelWorkflow(build.repo, build.runId);
      }
      
      showToast(`Cancelled ${selected.length} builds`, 'success');
    }
    
    async function cancelSelectedReleases() {
      const selected = Array.from(document.querySelectorAll('.release-checkbox:checked'))
        .map(cb => dashboardData.releases[cb.dataset.index])
        .filter(r => r.status === 'in_progress' || r.status === 'queued');
      
      if (selected.length === 0) {
        showToast('No running releases selected', 'error');
        return;
      }
      
      for (const release of selected) {
        await cancelWorkflow(release.repo, release.runId);
      }
      
      showToast(`Cancelled ${selected.length} releases`, 'success');
    }
    
    async function cancelWorkflow(repo, runId) {
      try {
        await fetch('/api/cancel/workflow', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User': 'user1'
          },
          body: JSON.stringify({ repo, runId })
        });
        
        setTimeout(loadDashboard, 1000);
      } catch (err) {
        console.error('Cancel workflow error:', err);
      }
    }
    
    async function viewLogs(repo, runId) {
      openModal('logsModal');
      document.getElementById('logsViewer').textContent = 'Loading logs...';
      
      try {
        const response = await fetch(`/api/logs/${repo}/${runId}`, {
          headers: { 'X-User': 'user1' }
        });
        const data = await response.json();
        
        const logsHtml = data.jobs.map(job => 
          `=== ${job.jobName} ===\n${job.logs || job.error || 'No logs available'}\n\n`
        ).join('');
        
        document.getElementById('logsViewer').textContent = logsHtml;
      } catch (err) {
        document.getElementById('logsViewer').textContent = 'Failed to load logs';
      }
    }
    
    async function executeScheduleJob() {
      const type = document.getElementById('scheduleType').value;
      const app = document.getElementById('scheduleApp').value;
      const scheduledTime = document.getElementById('scheduleTime').value;
      
      if (!scheduledTime) {
        showToast('Please select a schedule time', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/schedule/workflow', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User': 'user1'
          },
          body: JSON.stringify({
            repo: app,
            workflowId: type === 'build' ? 'build.yml' : 'release.yml',
            ref: currentBranch || 'main',
            scheduledTime: new Date(scheduledTime).toISOString()
          })
        });
        
        const data = await response.json();
        closeModal('scheduleModal');
        showToast('Workflow scheduled successfully', 'success');
        loadScheduledJobs();
      } catch (err) {
        showToast('Failed to schedule workflow', 'error');
      }
    }
    
    async function cancelScheduledJob(jobId) {
      try {
        await fetch(`/api/schedule/cancel/${jobId}`, {
          method: 'POST',
          headers: { 'X-User': 'user1' }
        });
        
        showToast('Scheduled job cancelled', 'success');
        loadScheduledJobs();
      } catch (err) {
        showToast('Failed to cancel scheduled job', 'error');
      }
    }
    
    function toggleTheme() {
      const current = document.documentElement.dataset.theme;
      document.documentElement.dataset.theme = current === 'dark' ? '' : 'dark';
      localStorage.setItem('theme', document.documentElement.dataset.theme);
    }
    
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.dataset.theme = 'dark';
    }
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
