name: App Build template

on:
  workflow_call:
    secrets:
      PAT:
        required: false
    inputs:
      appName: 
        type: string
        required: true
      appEnvironment: 
        type: string
        required: true
      workingDirectory:
        type: string
        required: true
      acrName: 
        type: string
        required: true
      acrResourceGroup:
        type: string
        required: true
      acaName: 
        type: string
        required: true
      acaResourceGroup:
        type: string
        required: true
        
jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6

      - name: build docker image
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          docker build -t ${{ inputs.appName }}:${{ github.run_id }} ${{ inputs.workingDirectory }}

      - name: docker save
        run: |
          docker save ${{ inputs.appName }}:${{ github.run_id }} -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-image
          path: image.tar
          retention-days: 1

      - name: trigger deployment
        uses: peter-evans/repository-dispatch@v4   # or @v4 if you prefer latest
        with:
          token: ${{ secrets.PAT }}                 # ‚Üê from Repo A
          repository: dpdeepankar/githubActionsReleaseRepo  # target repo
          event-type: ${{ inputs.appName }}
          client-payload: |
            {
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "runId": "${{ github.run_id }}",
              "appName": "${{ inputs.appName }}",
              "acrName": "${{ inputs.acrName }}",
              "acrResourceGroup": "${{ inputs.acrResourceGroup }}",
              "acaName": "${{ inputs.acaName }}",
              "acaResourceGroup": "${{ inputs.acaResourceGroup }}",
              "commit_short": "$SHORT_SHA"
            }
